<!DOCTYPE html>
<html>
</head>
<head>
    <title>Hydroponics Monitor</title>
    <link rel="stylesheet" href="/static/style.css">
    <script>
      setTimeout(function() {
        window.location.reload(1);
      }, 3000); // Refresh every 30 seconds
    </script>
</head>
</head>
<body>
    <h1>Hydroponics System Dashboard</h1>

    {% if status.get('timestamp') %}
        <p style="text-align: center; font-style: italic;">Last updated: {{ status['timestamp'] }}</p>
    {% endif %}

    <div class="container">
        <div class="video">
            <h2>Live Camera Feed</h2>
            <h3>Upper Garden</h3>
            <img src="{{ url_for('video_feed2') }}" width="480" />
            <h3>Lower Garden</h3>
            <img src="{{ url_for('video_feed1') }}" width="480" />
        </div>

        <div class="sensors">
            <h2>Sensor Readings</h2>
<ul>
    {% set temp = status.get('Air Temp', 'Disconnected') %}
    <li><strong>Air Temp:</strong>
        <span style='color: "{{ "gray" if temp == "Disconnected" else "red" if temp|float > 30 else "orange" if temp|float > 25 else "green" }}"'>{{ temp }}</span>
    </li>

    {% set temp = status.get('Water Temp Top', 'Disconnected') %}
    <li><strong>Water Temp (Top):</strong>
        <span style='color: "{{ "gray" if temp == "Disconnected" else "red" if temp|float > 30 else "orange" if temp|float > 25 else "green" }}"'>{{ temp }}</span>
    </li>

    {% set temp = status.get('Water Temp Bottom', 'Disconnected') %}
    <li><strong>Water Temp (Bottom):</strong>
        <span style='color: "{{ "gray" if temp == "Disconnected" else "red" if temp|float > 30 else "orange" if temp|float > 25 else "green" }}"'>{{ temp }}</span>
    </li>

    {% set ec = status.get('EC', 'Disconnected') %}
    <li><strong>EC:</strong>
        <span style='color: "{{ "gray" if ec == "Disconnected" else "red" if ec|float > 2 else "orange" if ec|float > 1.5 else "green" }}"'>{{ ec }}</span>
    </li>

    {% set ph = status.get('pH', 'Disconnected') %}
    <li><strong>pH:</strong>
        <span style='color: "{{ "gray" if ph == "Disconnected" else "red" if ph|float < 5.5 or ph|float > 7.5 else "orange" if 5.5 <= ph|float < 6.0 or 7.0 < ph|float <= 7.5 else "green" }}"'>{{ ph }}</span>
    </li>

    {% set top_float = status.get('Top Float', 'Disconnected') %}
    <li><strong>Top Float:</strong>
        <span style='color: "{{ "gray" if top_float == "Disconnected" else "red" if top_float == "Low" else "green" if top_float == "OK" else "black" }}"'>{{ top_float }}</span>
    </li>

    {% set bottom_float = status.get('Bottom Float', 'Disconnected') %}
    <li><strong>Bottom Float:</strong>
        <span style='color: "{{ "gray" if bottom_float == "Disconnected" else "red" if bottom_float == "Low" else "green" if bottom_float == "OK" else "black" }}"'>{{ bottom_float }}</span>
    </li>
</ul>

<h2>Relay Status</h2>
<ul>
    {% for relay in ['Top Light', 'Bottom Light', 'Top Pump', 'Bottom Pump'] %}
        {% set value = status.get('Relay ' + relay, 'Disconnected') %}
        <li><strong>{{ relay }}:</strong>
            <span style='color: "{{ "gray" if value == "Disconnected" else "red" if value == "Low" else "green" if value == "OK" else "black" }}"'>{{ value }}</span>
        </li>
    {% endfor %}
</ul>

<h2>Fan Status</h2>
<ul>
    {% for fan in ['Top Fan', 'Bottom Fan', 'Vent Fan', 'Circulation Fan'] %}
        {% set value = status.get('Relay ' + fan, 'Disconnected') %}
        <li><strong>{{ fan }}:</strong>
            <span style='color: "{{ "gray" if value == "Disconnected" else "red" if value == "Low" else "green" if value == "OK" else "black" }}"'>{{ value }}</span>
        </li>
    {% endfor %}
</ul>
        </div>
    </div>
<script>
  async function fetchStatus() {
    try {
      const response = await fetch("/status");
      const data = await response.json();

      const updateText = (id, value) => {
        const el = document.getElementById(id);
        if (el) el.textContent = value;
      };

      const updateColor = (id, value, thresholds) => {
        const el = document.getElementById(id);
        if (!el) return;

        let color = "black";
        if (value === "Disconnected") {
          color = "gray";
        } else {
          let val = parseFloat(value);
          if (isNaN(val)) {
            color = "black";
          } else {
            color = thresholds.find(t => t.cond(val)).color;
          }
        }
        el.style.color = color;
      };

      for (const [key, value] of Object.entries(data)) {
        const id = key.replace(/\s+/g, '_');
        updateText(id, value);
      }

      updateColor('Air_Temp', data['Air Temp'], [
        { cond: v => v > 30, color: 'red' },
        { cond: v => v > 25, color: 'orange' },
        { cond: v => true, color: 'green' }
      ]);

      updateColor('Water_Temp_Top', data['Water Temp Top'], [
        { cond: v => v > 30, color: 'red' },
        { cond: v => v > 25, color: 'orange' },
        { cond: v => true, color: 'green' }
      ]);

      updateColor('Water_Temp_Bottom', data['Water Temp Bottom'], [
        { cond: v => v > 30, color: 'red' },
        { cond: v => v > 25, color: 'orange' },
        { cond: v => true, color: 'green' }
      ]);

      updateColor('EC', data['EC'], [
        { cond: v => v > 2, color: 'red' },
        { cond: v => v > 1.5, color: 'orange' },
        { cond: v => true, color: 'green' }
      ]);

      updateColor('pH', data['pH'], [
        { cond: v => v < 5.5 || v > 7.5, color: 'red' },
        { cond: v => (v >= 5.5 && v < 6.0) || (v > 7.0 && v <= 7.5), color: 'orange' },
        { cond: v => true, color: 'green' }
      ]);
    } catch (err) {
      console.error("Failed to fetch status:", err);
    }
  }

  setInterval(fetchStatus, 5000);
  fetchStatus();
</script>
</body>
</html>